<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ABEV Tracker ‚Äî Georgia Special Elections</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root { --transition-speed: 0.25s; }

  [data-theme="dark"] {
    --bg: #0f1117; --bg-card: #181a22; --bg-card-hover: #1e2030;
    --bg-row: #1c1e28; --bg-row-alt: #1f2230; --bg-row-hover: #252838;
    --bg-expanded: #161821; --border: #2a2d3a; --border-light: #22252f;
    --text: #e8e9ed; --text-secondary: #9ca0b0; --text-muted: #6b6f82;
    --accent-blue: #4a9eff; --accent-green: #34d399; --accent-amber: #fbbf24;
    --accent-red: #f87171; --accent-purple: #a78bfa; --accent-teal: #2dd4bf;
    --status-accepted: #34d399; --status-issued: #4a9eff; --status-rejected: #f87171;
    --status-challenged: #fbbf24; --status-cancelled: #6b6f82; --bar-track: #252838;
    --section-bg: rgba(74,158,255,0.04); --section-border: rgba(74,158,255,0.12);
    --gop-color: #f87171; --dem-color: #60a5fa; --other-color: #a78bfa;
    --toggle-bg: #252838; --comparison-up: #34d399; --comparison-down: #f87171;
  }
  [data-theme="light"] {
    --bg: #f4f5f7; --bg-card: #ffffff; --bg-card-hover: #f8f9fb;
    --bg-row: #ffffff; --bg-row-alt: #f9fafb; --bg-row-hover: #f0f1f5;
    --bg-expanded: #f5f6f8; --border: #d8dbe3; --border-light: #e5e7ec;
    --text: #1a1d28; --text-secondary: #4a4f63; --text-muted: #8c90a0;
    --accent-blue: #2b7cd8; --accent-green: #16a06a; --accent-amber: #c08c00;
    --accent-red: #d44343; --accent-purple: #7c5cbf; --accent-teal: #0ea89a;
    --status-accepted: #16a06a; --status-issued: #2b7cd8; --status-rejected: #d44343;
    --status-challenged: #c08c00; --status-cancelled: #8c90a0; --bar-track: #e5e7ec;
    --section-bg: rgba(43,124,216,0.04); --section-border: rgba(43,124,216,0.15);
    --gop-color: #d44343; --dem-color: #2b7cd8; --other-color: #7c5cbf;
    --toggle-bg: #e5e7ec; --comparison-up: #16a06a; --comparison-down: #d44343;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text);
    line-height: 1.5; -webkit-font-smoothing: antialiased;
    transition: background var(--transition-speed), color var(--transition-speed);
  }
  .container { max-width: 1320px; margin: 0 auto; padding: 28px 24px; }

  /* HEADER */
  .page-header {
    display: flex; justify-content: space-between; align-items: flex-start;
    margin-bottom: 24px; flex-wrap: wrap; gap: 16px;
  }
  .header-left { flex: 1; min-width: 280px; }
  .header-right { display: flex; align-items: center; gap: 12px; }
  .election-badge {
    display: inline-flex; align-items: center; gap: 6px;
    background: rgba(74,158,255,0.1); border: 1px solid rgba(74,158,255,0.25);
    color: var(--accent-blue); font-size: 11px; font-weight: 600;
    letter-spacing: 0.06em; text-transform: uppercase;
    padding: 4px 10px; border-radius: 4px; margin-bottom: 8px;
  }
  .election-badge::before {
    content: ''; width: 6px; height: 6px; border-radius: 50%;
    background: var(--accent-blue); animation: pulse-dot 2s ease-in-out infinite;
  }
  @keyframes pulse-dot { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .page-header h1 {
    font-size: 24px; font-weight: 700; letter-spacing: -0.02em;
    color: var(--text); margin-bottom: 4px; transition: color var(--transition-speed);
  }
  .page-header .subtitle { font-size: 13px; color: var(--text-muted); }
  .page-header .subtitle span { color: var(--text-secondary); }

  .election-switcher select, .control-group select {
    background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); padding: 8px 36px 8px 12px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600;
    cursor: pointer; appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='%236b6f82' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat; background-position: right 12px center;
    transition: border-color 0.15s, background var(--transition-speed), color var(--transition-speed);
  }
  .election-switcher select:hover, .control-group select:hover { border-color: var(--accent-blue); }
  .control-group select:focus { outline: none; border-color: var(--accent-blue); }
  .control-group select { font-weight: 500; min-width: 180px; }

  /* THEME TOGGLE */
  .theme-toggle {
    display: flex; background: var(--toggle-bg); border-radius: 8px;
    padding: 3px; border: 1px solid var(--border-light);
    transition: background var(--transition-speed), border-color var(--transition-speed);
  }
  .theme-toggle button {
    display: flex; align-items: center; justify-content: center;
    width: 32px; height: 28px; border: none; border-radius: 6px;
    background: transparent; color: var(--text-muted); font-size: 15px;
    cursor: pointer; transition: all 0.2s;
  }
  .theme-toggle button.active {
    background: var(--bg-card); color: var(--text);
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }

  /* STAT SECTIONS */
  .stat-section {
    margin-bottom: 16px; border: 1px solid var(--section-border);
    border-radius: 10px; background: var(--section-bg); padding: 16px 18px;
    transition: background var(--transition-speed), border-color var(--transition-speed);
  }
  .stat-section-header { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
  .stat-section-icon {
    width: 28px; height: 28px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center; font-size: 14px;
  }
  .stat-section-icon.absentee { background: rgba(74,158,255,0.12); }
  .stat-section-icon.early { background: rgba(52,211,153,0.12); }
  .stat-section-icon.abev { background: rgba(167,139,250,0.12); }
  .stat-section-title {
    font-size: 12px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.07em; color: var(--text-secondary);
  }

  .stat-grid { display: grid; gap: 10px; }
  .stat-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
  .stat-grid.cols-3 { grid-template-columns: repeat(3, 1fr); }

  .stat-card {
    background: var(--bg-card); border: 1px solid var(--border-light);
    border-radius: 8px; padding: 14px 16px;
    transition: background var(--transition-speed), border-color var(--transition-speed);
  }
  .stat-card .stat-label {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.05em; color: var(--text-muted); margin-bottom: 4px; line-height: 1.3;
  }
  .stat-card .stat-value {
    font-family: 'JetBrains Mono', monospace; font-size: 24px;
    font-weight: 700; letter-spacing: -0.02em;
  }
  .stat-card .stat-sub { font-size: 12px; color: var(--text-muted); margin-top: 2px; }
  .stat-total { color: var(--text); }
  .stat-blue { color: var(--accent-blue); }
  .stat-green { color: var(--accent-green); }
  .stat-amber { color: var(--accent-amber); }
  .stat-red { color: var(--accent-red); }
  .stat-purple { color: var(--accent-purple); }
  .stat-teal { color: var(--accent-teal); }

  .comparison {
    display: inline-flex; align-items: center; gap: 3px;
    font-size: 11px; font-weight: 600; font-family: 'JetBrains Mono', monospace;
    padding: 2px 6px; border-radius: 4px; margin-top: 4px;
  }
  .comparison.up { background: rgba(52,211,153,0.1); color: var(--comparison-up); }
  .comparison.down { background: rgba(248,113,113,0.1); color: var(--comparison-down); }
  .comparison-label {
    font-family: 'DM Sans', sans-serif; font-weight: 500;
    color: var(--text-muted); font-size: 10px; margin-left: 2px;
  }

  .party-breakdown { display: flex; gap: 16px; align-items: center; margin-top: 6px; flex-wrap: wrap; }
  .party-chip { display: flex; align-items: center; gap: 5px; font-size: 12px; font-weight: 600; }
  .party-dot { width: 8px; height: 8px; border-radius: 50%; }
  .party-bar-track {
    height: 8px; border-radius: 4px; background: var(--bar-track);
    overflow: hidden; display: flex;
  }
  .party-bar-seg { height: 100%; transition: width 0.4s ease; }

  .chart-container {
    background: var(--bg-card); border: 1px solid var(--border-light);
    border-radius: 8px; padding: 16px 18px; height: 220px;
    transition: background var(--transition-speed), border-color var(--transition-speed);
  }
  .chart-container canvas { width: 100% !important; height: 100% !important; }

  /* CONTROLS */
  .controls {
    display: flex; gap: 12px; align-items: flex-end;
    margin-bottom: 16px; flex-wrap: wrap;
  }
  .control-group { display: flex; flex-direction: column; gap: 4px; }
  .control-group label {
    font-size: 11px; font-weight: 600; text-transform: uppercase;
    letter-spacing: 0.06em; color: var(--text-muted);
  }
  .search-group { flex: 1; min-width: 200px; }
  .search-group input {
    width: 100%; background: var(--bg-card); border: 1px solid var(--border);
    color: var(--text); padding: 8px 12px; border-radius: 6px;
    font-family: 'DM Sans', sans-serif; font-size: 13px;
    transition: border-color 0.15s, background var(--transition-speed), color var(--transition-speed);
  }
  .search-group input::placeholder { color: var(--text-muted); }
  .search-group input:focus { outline: none; border-color: var(--accent-blue); }

  .status-legend { display: flex; gap: 16px; margin-bottom: 14px; flex-wrap: wrap; }
  .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 500; color: var(--text-secondary); }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

  /* TABLE */
  .table-wrapper {
    background: var(--bg-card); border: 1px solid var(--border-light);
    border-radius: 8px; overflow: hidden;
    transition: background var(--transition-speed), border-color var(--transition-speed);
  }
  table { width: 100%; border-collapse: collapse; table-layout: auto; }
  thead th {
    padding: 10px 14px; font-size: 10px; font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted);
    text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap;
    position: sticky; top: 0; background: var(--bg-card); z-index: 2;
    cursor: pointer; user-select: none;
    transition: color 0.15s, background var(--transition-speed);
  }
  thead th:hover { color: var(--text-secondary); }
  thead th.num { text-align: right; }
  thead th.sorted { color: var(--accent-blue); }
  thead th .sort-arrow { display: inline-block; margin-left: 4px; opacity: 0; transition: opacity 0.15s; }
  thead th.sorted .sort-arrow { opacity: 1; }

  tbody tr { border-bottom: 1px solid var(--border-light); cursor: pointer; transition: background 0.1s; }
  tbody tr:hover { background: var(--bg-row-hover); }
  tbody tr:nth-child(odd) { background: var(--bg-row); }
  tbody tr:nth-child(even) { background: var(--bg-row-alt); }
  tbody tr:nth-child(odd):hover, tbody tr:nth-child(even):hover { background: var(--bg-row-hover); }
  tbody td {
    padding: 10px 14px; font-size: 13px; color: var(--text);
    white-space: nowrap; transition: color var(--transition-speed);
  }
  td.num { text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 500; }
  td.county-cell { font-weight: 600; display: flex; align-items: center; gap: 8px; }
  .expand-icon {
    display: inline-flex; width: 18px; height: 18px;
    align-items: center; justify-content: center; border-radius: 4px;
    background: rgba(74,158,255,0.1); color: var(--accent-blue);
    font-size: 11px; font-weight: 700;
    transition: transform 0.2s, background 0.15s; flex-shrink: 0;
  }
  tr.expanded .expand-icon { transform: rotate(90deg); }

  .status-bar-cell { width: 140px; min-width: 140px; }
  .status-bar-wrapper { display: flex; height: 6px; border-radius: 3px; overflow: hidden; background: var(--bar-track); }
  .status-bar-segment { height: 100%; transition: width 0.3s ease; }

  tr.precinct-row { display: none; }
  tr.precinct-row.visible { display: table-row; }
  tr.precinct-row td {
    background: var(--bg-expanded); font-size: 12px; color: var(--text-secondary);
    border-bottom: 1px solid rgba(42,45,58,0.5);
  }
  tr.precinct-row td:first-child { padding-left: 42px; }
  tr.precinct-row td.num { font-size: 11px; }

  .table-footer {
    padding: 10px 14px; font-size: 12px; color: var(--text-muted);
    border-top: 1px solid var(--border-light);
    display: flex; justify-content: space-between; align-items: center;
  }
  .no-results { text-align: center; padding: 48px 20px; color: var(--text-muted); font-size: 14px; }

  .rate-meter { display: flex; align-items: center; gap: 8px; }
  .rate-meter-bar { width: 48px; height: 4px; border-radius: 2px; background: var(--bar-track); overflow: hidden; }
  .rate-meter-fill { height: 100%; border-radius: 2px; transition: width 0.3s ease; }
  .rate-meter-value { font-family: 'JetBrains Mono', monospace; font-size: 11px; font-weight: 500; min-width: 38px; text-align: right; }

  /* RESPONSIVE */
  @media (max-width: 1024px) {
    .stat-grid.cols-4 { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 768px) {
    .container { padding: 16px 12px; }
    .stat-grid.cols-4, .stat-grid.cols-3 { grid-template-columns: 1fr 1fr; }
    .controls { flex-direction: column; }
    .control-group select { min-width: 100%; }
    thead th, tbody td { padding: 8px; font-size: 12px; }
    td.num { font-size: 11px; }
    .status-bar-cell { display: none; }
    .page-header h1 { font-size: 18px; }
    .stat-card .stat-value { font-size: 20px; }
    .page-header { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="container">

  <div class="page-header">
    <div class="header-left">
      <div class="election-badge">Live Tracking</div>
      <h1 id="pageTitle">CD-14 Special Election ‚Äî ABEV Tracker</h1>
      <div class="subtitle">
        <span id="electionDate">March 2026</span> ¬∑ <span>Source: GA Secretary of State</span> ¬∑ Last synced: <span id="lastSync">Feb 6, 2026 1:41 PM</span>
      </div>
    </div>
    <div class="header-right">
      <div class="election-switcher">
        <select id="electionSelect">
          <option value="cd14_special">CD-14 Special ‚Äî Mar 2026</option>
          <option value="sd18_special">SD-18 Special ‚Äî Mar 17, 2026</option>
          <option value="cd14_runoff">CD-14 Runoff ‚Äî Apr 7, 2026</option>
        </select>
      </div>
      <div class="theme-toggle" id="themeToggle">
        <button id="btnDark" title="Dark mode">üåô</button>
        <button id="btnLight" class="active" title="Light mode">‚òÄÔ∏è</button>
      </div>
    </div>
  </div>

  <div id="statSections"></div>

  <div class="controls">
    <div class="control-group">
      <label>View By</label>
      <select id="viewBySelect">
        <option value="county">County</option>
        <option value="ballot_status">Ballot Status</option>
        <option value="party">Party</option>
        <option value="house">House District</option>
        <option value="sen">Senate District</option>
      </select>
    </div>
    <div class="control-group">
      <label>Ballot Status</label>
      <select id="statusFilter"><option value="all">All Statuses</option></select>
    </div>
    <div class="control-group">
      <label>County</label>
      <select id="countyFilter"><option value="all">All Counties</option></select>
    </div>
    <div class="control-group search-group">
      <label>Search Voter</label>
      <input type="text" id="voterSearch" placeholder="Last name, registration #, or precinct...">
    </div>
  </div>

  <div class="status-legend" id="statusLegend"></div>

  <div class="table-wrapper">
    <table>
      <thead id="tableHead"></thead>
      <tbody id="tableBody"></tbody>
    </table>
    <div class="table-footer" id="tableFooter"></div>
  </div>
</div>

<script>
// ============================================================
// ELECTION CONFIGS
// ============================================================
const ELECTIONS = {
  cd14_special: {
    title: 'CD-14 Special Election ‚Äî ABEV Tracker', date: 'March 2026',
    lastSync: 'Feb 6, 2026 1:41 PM',
    counties: ['Bartow','Carroll','Catoosa','Chattooga','Cherokee','Cobb','Dade','Dawson','Douglas','Fannin','Floyd','Forsyth','Gilmer','Gordon','Haralson','Lumpkin','Murray','Paulding','Pickens','Polk','Towns','Union','Walker','Whitfield'],
    houseDistricts: ['6','7','8','9','10','11','12','14','15','16','17','18'],
    senateDistricts: ['51','52','53','54'], cng: '14',
    historical2022: 14200, historical2024: 18900,
  },
  sd18_special: {
    title: 'SD-18 Special Election ‚Äî ABEV Tracker', date: 'March 17, 2026',
    lastSync: 'Feb 6, 2026 1:38 PM',
    counties: ['Butts','Henry','Jasper','Monroe','Newton','Spalding'],
    houseDistricts: ['94','95','96','114','115'],
    senateDistricts: ['17','18'], cng: '4',
    historical2022: 5800, historical2024: 7600,
  },
  cd14_runoff: {
    title: 'CD-14 Runoff ‚Äî ABEV Tracker', date: 'April 7, 2026',
    lastSync: 'Feb 6, 2026 1:45 PM',
    counties: ['Bartow','Carroll','Catoosa','Chattooga','Cherokee','Cobb','Dade','Dawson','Douglas','Fannin','Floyd','Forsyth','Gilmer','Gordon','Haralson','Lumpkin','Murray','Paulding','Pickens','Polk','Towns','Union','Walker','Whitfield'],
    houseDistricts: ['6','7','8','9','10','11','12','14','15','16','17','18'],
    senateDistricts: ['51','52','53','54'], cng: '14',
    historical2022: 8100, historical2024: 10200,
  }
};

const BALLOT_STATUS_LABELS = { A:'Accepted', I:'Issued', R:'Rejected', C:'Cancelled', P:'Provisional', S:'Spoiled' };
const BALLOT_STATUS_COLORS = { A:'var(--status-accepted)', I:'var(--status-issued)', R:'var(--status-rejected)', C:'var(--status-cancelled)', P:'var(--status-challenged)', S:'var(--accent-amber)' };
const PARTY_LABELS = { R:'Republican', D:'Democrat', NP:'Non-Partisan', L:'Libertarian', '':'Not Specified' };
const NAMES_LAST = ['SMITH','JOHNSON','WILLIAMS','BROWN','JONES','GARCIA','MILLER','DAVIS','WILSON','MOORE','TAYLOR','ANDERSON','THOMAS','JACKSON','WHITE','HARRIS','MARTIN','THOMPSON','ROBINSON','CLARK','LEWIS','LEE','WALKER','HALL','ALLEN','YOUNG','KING','WRIGHT','HILL','GREEN'];
const NAMES_FIRST = ['JAMES','MARY','JOHN','PATRICIA','ROBERT','JENNIFER','MICHAEL','LINDA','WILLIAM','ELIZABETH','DAVID','BARBARA','RICHARD','SUSAN','JOSEPH','JESSICA','THOMAS','SARAH','CHARLES','KAREN'];

function randomDate(start, end) {
  const d = new Date(start.getTime() + Math.random() * (end.getTime() - start.getTime()));
  return `${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getDate().toString().padStart(2,'0')}/${d.getFullYear()}`;
}
function parseDate(s) {
  if (!s) return null;
  const [m,d,y] = s.split('/').map(Number);
  return new Date(y, m-1, d);
}
function pick(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

function generateMockData(electionKey) {
  const cfg = ELECTIONS[electionKey];
  const data = [];
  const now = new Date(2026, 1, 6);
  const appStart = new Date(2026, 0, 15);
  const issueStart = new Date(2026, 0, 20);

  cfg.counties.forEach(county => {
    const baseCount = Math.floor(Math.random() * 55) + 15;
    const numPrecincts = Math.floor(Math.random() * 8) + 3;
    const precincts = [];
    for (let p = 0; p < numPrecincts; p++)
      precincts.push(`${county.substring(0,3).toUpperCase()}${(p+1).toString().padStart(2,'0')}`);

    for (let i = 0; i < baseCount; i++) {
      const isAbsentee = Math.random() < 0.35;
      const statusReason = isAbsentee ? 'ABSENTEE BY MAIL' : 'ADVANCE IN PERSON';
      let ballotStatus;
      if (isAbsentee) {
        const r = Math.random();
        ballotStatus = r<0.35?'A':r<0.60?'I':r<0.70?'R':r<0.80?'C':r<0.88?'P':'S';
      } else {
        const r = Math.random();
        ballotStatus = r<0.88?'A':r<0.94?'I':r<0.97?'P':'R';
      }
      const hasIssued = ['A','I','R','S'].includes(ballotStatus);
      const hasReturn = ['A','R','S'].includes(ballotStatus);
      const partyRoll = Math.random();
      const party = partyRoll<0.40?'R':partyRoll<0.70?'D':partyRoll<0.90?'NP':partyRoll<0.95?'L':'';

      data.push({
        county,
        voter_registration_number: (10000000 + Math.floor(Math.random()*9000000)).toString(),
        last_name: pick(NAMES_LAST), first_name: pick(NAMES_FIRST),
        middle_name: pick(['A','B','C','D','E','J','L','M','R','S','']),
        suffix: '',
        street_number: (100+Math.floor(Math.random()*9000)).toString(),
        street_name: pick(['MAIN ST','OAK AVE','PINE RD','MAPLE DR','ELM ST','CEDAR LN','PEACH ST','WALNUT AVE']),
        apt_unit: '', city: county.toUpperCase(), state: 'GA',
        zip_code: (30000+Math.floor(Math.random()*2000)).toString(),
        mailing_street_number:'', mailing_street_name:'', mailing_apt_unit:'',
        mailing_city:'', mailing_state:'', mailing_zip_code:'',
        application_status: ballotStatus==='C'?'C':'A',
        ballot_status: ballotStatus,
        status_reason: statusReason,
        application_date: randomDate(appStart, now),
        ballot_issued_date: hasIssued ? randomDate(issueStart, now) : '',
        ballot_return_date: hasReturn ? randomDate(issueStart, now) : '',
        ballot_style: statusReason,
        ballot_assisted: Math.random()>0.95?'Y':'',
        challenged_provisional: ballotStatus==='P'?'Y':'',
        id_required: Math.random()>0.92?'Y':'',
        municipal_precinct: '',
        county_precinct: pick(precincts),
        cng: cfg.cng,
        sen: pick(cfg.senateDistricts),
        house: pick(cfg.houseDistricts),
        jud: '', combo_number: '',
        vote_center_id: !isAbsentee ? `VC-${county.substring(0,3).toUpperCase()}-${Math.floor(Math.random()*3)+1}` : '',
        ballot_id: hasIssued ? `BID-${Math.floor(Math.random()*90000)+10000}` : '',
        party
      });
    }
  });
  return data;
}

const ELECTION_DATA = {};
Object.keys(ELECTIONS).forEach(k => { ELECTION_DATA[k] = generateMockData(k); });

let currentElection = 'cd14_special';
let DATA = ELECTION_DATA[currentElection];
let dailyChart = null;

// ============================================================
// THEME
// ============================================================
const btnDark = document.getElementById('btnDark');
const btnLight = document.getElementById('btnLight');
function setTheme(t) {
  document.documentElement.setAttribute('data-theme', t);
  btnDark.classList.toggle('active', t==='dark');
  btnLight.classList.toggle('active', t==='light');
  if (dailyChart) renderDailyChart();
}
btnDark.addEventListener('click', ()=>setTheme('dark'));
btnLight.addEventListener('click', ()=>setTheme('light'));

// ============================================================
// ELECTION SWITCHER
// ============================================================
const electionSelect = document.getElementById('electionSelect');
electionSelect.addEventListener('change', () => {
  currentElection = electionSelect.value;
  DATA = ELECTION_DATA[currentElection];
  const cfg = ELECTIONS[currentElection];
  document.getElementById('pageTitle').textContent = cfg.title;
  document.getElementById('electionDate').textContent = cfg.date;
  document.getElementById('lastSync').textContent = cfg.lastSync;
  expandedRows.clear();
  rebuildFilters();
  renderAll();
});

// ============================================================
// DOM REFS
// ============================================================
const viewBySelect = document.getElementById('viewBySelect');
const statusFilter = document.getElementById('statusFilter');
const countyFilter = document.getElementById('countyFilter');
const voterSearch = document.getElementById('voterSearch');
const tableHead = document.getElementById('tableHead');
const tableBody = document.getElementById('tableBody');
const tableFooter = document.getElementById('tableFooter');
const statusLegend = document.getElementById('statusLegend');
const statSections = document.getElementById('statSections');

function rebuildFilters() {
  statusFilter.innerHTML = '<option value="all">All Statuses</option>';
  countyFilter.innerHTML = '<option value="all">All Counties</option>';
  voterSearch.value = '';
  [...new Set(DATA.map(r=>r.ballot_status))].sort().forEach(s => {
    const o = document.createElement('option'); o.value=s; o.textContent=BALLOT_STATUS_LABELS[s]||s;
    statusFilter.appendChild(o);
  });
  [...new Set(DATA.map(r=>r.county))].sort().forEach(c => {
    const o = document.createElement('option'); o.value=c; o.textContent=c;
    countyFilter.appendChild(o);
  });
}

function getFilteredData() {
  let f = [...DATA];
  const sf=statusFilter.value, cf=countyFilter.value, q=voterSearch.value.trim().toLowerCase();
  if (sf!=='all') f=f.filter(r=>r.ballot_status===sf);
  if (cf!=='all') f=f.filter(r=>r.county===cf);
  if (q) f=f.filter(r=>r.last_name.toLowerCase().includes(q)||r.first_name.toLowerCase().includes(q)||r.voter_registration_number.includes(q)||r.county_precinct.toLowerCase().includes(q));
  return f;
}

// ============================================================
// STAT SECTIONS
// ============================================================
function comparisonHTML(current, historical, label) {
  if (!historical) return '';
  const diff = current - historical;
  const pct = ((diff/historical)*100).toFixed(1);
  const cls = diff >= 0 ? 'up' : 'down';
  const arrow = diff >= 0 ? '‚Üë' : '‚Üì';
  return `<div class="comparison ${cls}">${arrow} ${Math.abs(pct)}% <span class="comparison-label">vs ${label}</span></div>`;
}

function renderStatSections() {
  const filtered = getFilteredData();
  const cfg = ELECTIONS[currentElection];

  // Absentee
  const absentee = filtered.filter(r => r.status_reason === 'ABSENTEE BY MAIL');
  const absRequested = absentee.length;
  const absCast = absentee.filter(r => r.ballot_return_date).length;
  const absOutstanding = absRequested - absCast;
  const returnTimes = [];
  absentee.forEach(r => {
    if (r.ballot_return_date && r.ballot_issued_date) {
      const d = (parseDate(r.ballot_return_date) - parseDate(r.ballot_issued_date)) / 864e5;
      if (d >= 0) returnTimes.push(d);
    }
  });
  const avgReturn = returnTimes.length ? (returnTimes.reduce((a,b)=>a+b,0)/returnTimes.length).toFixed(1) : null;

  // Early In-Person
  const earlyIP = filtered.filter(r => r.status_reason === 'ADVANCE IN PERSON');
  const eipCast = earlyIP.filter(r => r.ballot_status === 'A').length;
  const hist2022EIP = Math.round(cfg.historical2022 * 0.65);
  const hist2024EIP = Math.round(cfg.historical2024 * 0.65);

  // ABEV Totals
  const totalCast = absCast + eipCast;
  const castVoters = filtered.filter(r => r.ballot_return_date || (r.status_reason==='ADVANCE IN PERSON' && r.ballot_status==='A'));
  const partyC = { GOP:0, DEM:0, Other:0 };
  castVoters.forEach(r => { r.party==='R'?partyC.GOP++:r.party==='D'?partyC.DEM++:partyC.Other++; });
  const pTotal = Object.values(partyC).reduce((a,b)=>a+b,0)||1;

  statSections.innerHTML = `
    <div class="stat-section">
      <div class="stat-section-header">
        <div class="stat-section-icon absentee">‚úâÔ∏è</div>
        <div class="stat-section-title">Absentee Voting (By Mail)</div>
      </div>
      <div class="stat-grid cols-4">
        <div class="stat-card">
          <div class="stat-label">Total Requested</div>
          <div class="stat-value stat-blue">${absRequested.toLocaleString()}</div>
          <div class="stat-sub">${(absRequested/(filtered.length||1)*100).toFixed(1)}% of all applications</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Votes Cast</div>
          <div class="stat-value stat-green">${absCast.toLocaleString()}</div>
          <div class="stat-sub">${absRequested>0?(absCast/absRequested*100).toFixed(1):0}% return rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Outstanding</div>
          <div class="stat-value stat-amber">${absOutstanding.toLocaleString()}</div>
          <div class="stat-sub">ballots not yet returned</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Avg Return Time</div>
          <div class="stat-value stat-teal">${avgReturn ?? '‚Äî'}</div>
          <div class="stat-sub">${avgReturn ? 'days from issue to return' : 'no returns yet'}</div>
        </div>
      </div>
    </div>

    <div class="stat-section">
      <div class="stat-section-header">
        <div class="stat-section-icon early">üèõÔ∏è</div>
        <div class="stat-section-title">Early In-Person Voting</div>
      </div>
      <div class="stat-grid cols-3">
        <div class="stat-card">
          <div class="stat-label">Total Votes Cast</div>
          <div class="stat-value stat-green">${eipCast.toLocaleString()}</div>
          <div class="stat-sub">${earlyIP.length.toLocaleString()} total check-ins</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">vs 2022 ABEV</div>
          <div class="stat-value stat-total">${eipCast.toLocaleString()}</div>
          ${comparisonHTML(eipCast, hist2022EIP, '2022')}
        </div>
        <div class="stat-card">
          <div class="stat-label">vs 2024 ABEV</div>
          <div class="stat-value stat-total">${eipCast.toLocaleString()}</div>
          ${comparisonHTML(eipCast, hist2024EIP, '2024')}
        </div>
      </div>
    </div>

    <div class="stat-section">
      <div class="stat-section-header">
        <div class="stat-section-icon abev">üìä</div>
        <div class="stat-section-title">Combined ABEV Results</div>
      </div>
      <div class="stat-grid cols-4">
        <div class="stat-card">
          <div class="stat-label">Total ABEV Votes Cast</div>
          <div class="stat-value stat-purple">${totalCast.toLocaleString()}</div>
          <div class="stat-sub">${absCast.toLocaleString()} mail + ${eipCast.toLocaleString()} in-person</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">vs 2022 ABEV</div>
          <div class="stat-value stat-total">${totalCast.toLocaleString()}</div>
          ${comparisonHTML(totalCast, cfg.historical2022, '2022')}
        </div>
        <div class="stat-card">
          <div class="stat-label">vs 2024 ABEV</div>
          <div class="stat-value stat-total">${totalCast.toLocaleString()}</div>
          ${comparisonHTML(totalCast, cfg.historical2024, '2024')}
        </div>
        <div class="stat-card">
          <div class="stat-label">Party Breakdown</div>
          <div class="party-breakdown">
            <div class="party-chip"><div class="party-dot" style="background:var(--gop-color)"></div><span style="color:var(--gop-color)">GOP ${(partyC.GOP/pTotal*100).toFixed(1)}%</span></div>
            <div class="party-chip"><div class="party-dot" style="background:var(--dem-color)"></div><span style="color:var(--dem-color)">DEM ${(partyC.DEM/pTotal*100).toFixed(1)}%</span></div>
            <div class="party-chip"><div class="party-dot" style="background:var(--other-color)"></div><span style="color:var(--other-color)">Other ${(partyC.Other/pTotal*100).toFixed(1)}%</span></div>
          </div>
          <div class="party-bar-track" style="margin-top:8px">
            <div class="party-bar-seg" style="width:${partyC.GOP/pTotal*100}%;background:var(--gop-color)"></div>
            <div class="party-bar-seg" style="width:${partyC.DEM/pTotal*100}%;background:var(--dem-color)"></div>
            <div class="party-bar-seg" style="width:${partyC.Other/pTotal*100}%;background:var(--other-color)"></div>
          </div>
          <div class="stat-sub" style="margin-top:6px">${partyC.GOP.toLocaleString()} ¬∑ ${partyC.DEM.toLocaleString()} ¬∑ ${partyC.Other.toLocaleString()}</div>
        </div>
      </div>
    </div>

    <div class="stat-section">
      <div class="stat-section-header">
        <div class="stat-section-icon abev">üìà</div>
        <div class="stat-section-title">Total Votes by Day</div>
      </div>
      <div class="chart-container">
        <canvas id="dailyChartCanvas"></canvas>
      </div>
    </div>`;

  renderDailyChart();
}

// ============================================================
// DAILY CHART
// ============================================================
function renderDailyChart() {
  const canvas = document.getElementById('dailyChartCanvas');
  if (!canvas) return;
  if (dailyChart) { dailyChart.destroy(); dailyChart = null; }

  const filtered = getFilteredData();
  const dailyCounts = {};
  filtered.forEach(r => {
    let d = null;
    if (r.status_reason==='ADVANCE IN PERSON' && r.application_date) d = r.application_date;
    else if (r.ballot_return_date) d = r.ballot_return_date;
    if (d) dailyCounts[d] = (dailyCounts[d]||0) + 1;
  });

  const sorted = Object.keys(dailyCounts).sort((a,b)=>parseDate(a)-parseDate(b));
  const labels = sorted.map(d=>{ const dt=parseDate(d); return `${dt.getMonth()+1}/${dt.getDate()}`; });
  const values = sorted.map(d=>dailyCounts[d]);

  if (!values.length) { dailyChart = null; return; }

  const dark = document.documentElement.getAttribute('data-theme')==='dark';
  const grid = dark?'rgba(255,255,255,0.06)':'rgba(0,0,0,0.06)';
  const txt = dark?'#6b6f82':'#8c90a0';
  const line = dark?'#4a9eff':'#2b7cd8';
  const fill = dark?'rgba(74,158,255,0.10)':'rgba(43,124,216,0.08)';

  dailyChart = new Chart(canvas, {
    type:'line',
    data:{
      labels,
      datasets:[{
        data:values, borderColor:line, backgroundColor:fill, fill:true,
        tension:0.3, pointRadius:3, pointBackgroundColor:line,
        pointBorderColor:dark?'#181a22':'#fff', pointBorderWidth:2,
        pointHoverRadius:5, borderWidth:2
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:dark?'#252838':'#fff',
          titleColor:dark?'#e8e9ed':'#1a1d28',
          bodyColor:dark?'#9ca0b0':'#4a4f63',
          borderColor:dark?'#2a2d3a':'#d8dbe3', borderWidth:1,
          padding:10, cornerRadius:6,
          titleFont:{family:'DM Sans',weight:'600',size:12},
          bodyFont:{family:'JetBrains Mono',size:12},
          callbacks:{label:ctx=>`${ctx.parsed.y.toLocaleString()} votes`}
        }
      },
      scales:{
        x:{grid:{display:false},ticks:{color:txt,font:{family:'DM Sans',size:10},maxRotation:45}},
        y:{grid:{color:grid},ticks:{color:txt,font:{family:'JetBrains Mono',size:10}},beginAtZero:true}
      }
    }
  });
}

// ============================================================
// TABLE
// ============================================================
function renderLegend() {
  statusLegend.innerHTML = Object.entries(BALLOT_STATUS_LABELS).map(([c,l])=>
    `<div class="legend-item"><div class="legend-dot" style="background:${BALLOT_STATUS_COLORS[c]}"></div>${l}</div>`
  ).join('');
}

function groupData(f, g) {
  const groups={};
  f.forEach(r=>{
    let k;
    switch(g){
      case 'county':k=r.county;break;
      case 'ballot_status':k=BALLOT_STATUS_LABELS[r.ballot_status]||r.ballot_status;break;
      case 'party':k=PARTY_LABELS[r.party]||r.party||'Not Specified';break;
      case 'house':k=r.house?`HD-${r.house}`:'Unknown';break;
      case 'sen':k=r.sen?`SD-${r.sen}`:'Unknown';break;
      default:k=r.county;
    }
    if(!groups[k])groups[k]=[];
    groups[k].push(r);
  });
  return groups;
}
function getSubGroups(recs,g){
  const s={};
  recs.forEach(r=>{
    const k=g==='county'?(r.county_precinct||'Unknown Precinct'):r.county;
    if(!s[k])s[k]=[];
    s[k].push(r);
  });
  return s;
}
function statusBarHTML(recs){
  const c={};recs.forEach(r=>{c[r.ballot_status]=(c[r.ballot_status]||0)+1;});
  const t=recs.length;if(!t)return'';
  return `<div class="status-bar-wrapper">${Object.entries(c).sort((a,b)=>b[1]-a[1]).map(([s,n])=>`<div class="status-bar-segment" style="width:${n/t*100}%;background:${BALLOT_STATUS_COLORS[s]||'var(--text-muted)'}"></div>`).join('')}</div>`;
}
function returnRateHTML(recs){
  const issued=recs.filter(r=>['A','I','R','S'].includes(r.ballot_status)).length;
  const returned=recs.filter(r=>r.ballot_return_date).length;
  if(!issued)return'<span style="color:var(--text-muted)">‚Äî</span>';
  const rate=returned/issued*100;
  const color=rate>=80?'var(--accent-green)':rate>=50?'var(--accent-amber)':'var(--accent-red)';
  return `<div class="rate-meter"><div class="rate-meter-bar"><div class="rate-meter-fill" style="width:${rate}%;background:${color}"></div></div><span class="rate-meter-value" style="color:${color}">${rate.toFixed(1)}%</span></div>`;
}

let currentSort={col:'total',dir:'desc'};
let expandedRows=new Set();

function renderTable(){
  const filtered=getFilteredData();
  const groupBy=viewBySelect.value;
  const groups=groupData(filtered,groupBy);
  const groupLabel={county:'County',ballot_status:'Ballot Status',party:'Party',house:'House District',sen:'Senate District'}[groupBy];

  tableHead.innerHTML=`<tr>
    <th style="width:28px"></th>
    <th class="${currentSort.col==='name'?'sorted':''}" data-sort="name">${groupLabel}<span class="sort-arrow">${currentSort.col==='name'?(currentSort.dir==='asc'?'‚Üë':'‚Üì'):''}</span></th>
    <th class="num ${currentSort.col==='total'?'sorted':''}" data-sort="total">Total<span class="sort-arrow">${currentSort.col==='total'?(currentSort.dir==='asc'?'‚Üë':'‚Üì'):''}</span></th>
    <th class="num" data-sort="accepted">Accepted</th>
    <th class="num" data-sort="issued">Issued</th>
    <th class="num" data-sort="rejected">Rejected</th>
    <th class="num" data-sort="inperson">In-Person</th>
    <th class="num" data-sort="mail">By Mail</th>
    <th>Return Rate</th>
    <th class="status-bar-cell">Status Mix</th>
  </tr>`;

  let keys=Object.keys(groups);
  keys.sort((a,b)=>{
    let va,vb;
    switch(currentSort.col){
      case 'name':va=a;vb=b;break;
      case 'total':va=groups[a].length;vb=groups[b].length;break;
      case 'accepted':va=groups[a].filter(r=>r.ballot_status==='A').length;vb=groups[b].filter(r=>r.ballot_status==='A').length;break;
      case 'issued':va=groups[a].filter(r=>['A','I','R','S'].includes(r.ballot_status)).length;vb=groups[b].filter(r=>['A','I','R','S'].includes(r.ballot_status)).length;break;
      case 'rejected':va=groups[a].filter(r=>r.ballot_status==='R').length;vb=groups[b].filter(r=>r.ballot_status==='R').length;break;
      default:va=groups[a].length;vb=groups[b].length;
    }
    if(typeof va==='string')return currentSort.dir==='asc'?va.localeCompare(vb):vb.localeCompare(va);
    return currentSort.dir==='asc'?va-vb:vb-va;
  });

  let html='';
  keys.forEach(key=>{
    const recs=groups[key],total=recs.length;
    const accepted=recs.filter(r=>r.ballot_status==='A').length;
    const issued=recs.filter(r=>['A','I','R','S'].includes(r.ballot_status)).length;
    const rejected=recs.filter(r=>r.ballot_status==='R').length;
    const inP=recs.filter(r=>r.vote_center_id).length;
    const byM=total-inP;
    const exp=expandedRows.has(key);

    html+=`<tr class="group-row ${exp?'expanded':''}" data-group="${key}">
      <td><span class="expand-icon">‚Ä∫</span></td>
      <td class="county-cell">${key}</td>
      <td class="num">${total.toLocaleString()}</td>
      <td class="num" style="color:var(--status-accepted)">${accepted.toLocaleString()}</td>
      <td class="num" style="color:var(--status-issued)">${issued.toLocaleString()}</td>
      <td class="num" style="color:var(--status-rejected)">${rejected.toLocaleString()}</td>
      <td class="num">${inP.toLocaleString()}</td>
      <td class="num">${byM.toLocaleString()}</td>
      <td>${returnRateHTML(recs)}</td>
      <td class="status-bar-cell">${statusBarHTML(recs)}</td>
    </tr>`;

    if(exp){
      const subs=getSubGroups(recs,groupBy);
      Object.keys(subs).sort().forEach(sk=>{
        const sr=subs[sk],st=sr.length;
        html+=`<tr class="precinct-row visible">
          <td></td><td>${sk}</td>
          <td class="num">${st.toLocaleString()}</td>
          <td class="num" style="color:var(--status-accepted)">${sr.filter(r=>r.ballot_status==='A').length.toLocaleString()}</td>
          <td class="num" style="color:var(--status-issued)">${sr.filter(r=>['A','I','R','S'].includes(r.ballot_status)).length.toLocaleString()}</td>
          <td class="num" style="color:var(--status-rejected)">${sr.filter(r=>r.ballot_status==='R').length.toLocaleString()}</td>
          <td class="num">${sr.filter(r=>r.vote_center_id).length.toLocaleString()}</td>
          <td class="num">${(st-sr.filter(r=>r.vote_center_id).length).toLocaleString()}</td>
          <td>${returnRateHTML(sr)}</td>
          <td class="status-bar-cell">${statusBarHTML(sr)}</td>
        </tr>`;
      });
    }
  });

  tableBody.innerHTML=html||'<tr><td colspan="10" class="no-results">No records match your filters</td></tr>';
  tableFooter.innerHTML=`<span>${filtered.length.toLocaleString()} records across ${keys.length} ${groupLabel.toLowerCase()}${keys.length!==1?'s':''}</span><span>Click any row to expand</span>`;

  document.querySelectorAll('.group-row').forEach(row=>{
    row.addEventListener('click',()=>{
      const g=row.dataset.group;
      expandedRows.has(g)?expandedRows.delete(g):expandedRows.add(g);
      renderTable();
    });
  });
  document.querySelectorAll('thead th[data-sort]').forEach(th=>{
    th.addEventListener('click',e=>{
      e.stopPropagation();
      const col=th.dataset.sort;
      if(currentSort.col===col)currentSort.dir=currentSort.dir==='desc'?'asc':'desc';
      else currentSort={col,dir:'desc'};
      renderTable();
    });
  });
}

function renderAll(){ renderStatSections(); renderLegend(); renderTable(); }

rebuildFilters();
renderAll();

viewBySelect.addEventListener('change',()=>{expandedRows.clear();renderTable();});
statusFilter.addEventListener('change',()=>{renderStatSections();renderTable();});
countyFilter.addEventListener('change',()=>{renderStatSections();renderTable();});
let searchTimeout;
voterSearch.addEventListener('input',()=>{
  clearTimeout(searchTimeout);
  searchTimeout=setTimeout(()=>{renderStatSections();renderTable();},250);
});
</script>
</body>
</html>
