<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GA Campaign Finance</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* ============================================
   Workspace Theme — Campaign Finance
   Inspired by Asana / Monday / Airtable
   White canvas, colorful data, clean type
   ============================================ */

:root {
  /* Palette — vivid data colors on white */
  --raised: #00A86B;
  --raised-soft: #E8F8F0;
  --spent: #E8590C;
  --spent-soft: #FFF0E8;
  --cash: #5B5FC7;
  --cash-soft: #EDEDFC;

  /* Party — saturated, clear, readable */
  --dem: #1976D2;
  --dem-bg: #E3F2FD;
  --gop: #D32F2F;
  --gop-bg: #FFEBEE;
  --ind: #7B1FA2;
  --ind-bg: #F3E5F5;
  --lib: #E6A817;
  --lib-bg: #FFF8E1;
  --oth: #607D8B;
  --oth-bg: #ECEFF1;

  /* Chrome — whites and near-whites */
  --white: #FFFFFF;
  --bg: #FFFFFF;
  --tint: #F8F9FB;
  --border: #E4E7EC;
  --border-soft: #F0F1F4;

  /* Type */
  --ink: #1B2028;
  --ink-2: #4A5264;
  --ink-3: #8B94A7;
  --ink-4: #B8BFCC;

  /* System */
  --font: 'DM Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --mono: 'DM Mono', 'SF Mono', 'Fira Code', Consolas, monospace;
  --r: 8px;
  --r-pill: 100px;
  --ease: cubic-bezier(.4,0,.2,1);
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{-webkit-text-size-adjust:100%;scroll-behavior:smooth}
body{font-family:var(--font);background:var(--bg);color:var(--ink);-webkit-font-smoothing:antialiased;font-size:15px;line-height:1.55}
input,button,select{font:inherit}

.container{width:100%;max-width:1200px;margin:0 auto;padding:16px}

/* ── Loading / Error ── */
.loading{display:flex;flex-direction:column;align-items:center;padding:48px;color:var(--ink-3);gap:12px;font-size:14px}
.spinner{width:24px;height:24px;border:2.5px solid var(--border);border-top-color:var(--cash);border-radius:50%;animation:spin .65s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.error-box{background:#FFF5F5;border:1px solid #FED7D7;border-radius:var(--r);padding:16px;color:#9B2C2C;font-size:14px;margin-bottom:16px}
.error-box strong{display:block;margin-bottom:2px}

/* ── Page Title ── */
.page-title{font-size:20px;font-weight:700;color:var(--ink);letter-spacing:-.025em;margin-bottom:4px}
.page-sub{font-size:13px;color:var(--ink-3);margin-bottom:20px}

/* ============================================
   VIEW TOGGLE — clean pill switch
   ============================================ */
.view-toggle{
  display:inline-flex;
  background:var(--tint);
  border:1px solid var(--border);
  border-radius:var(--r-pill);
  padding:3px;
  margin-bottom:16px;
  width:100%;
}
.view-toggle button{
  flex:1;
  padding:7px 16px;
  border:none;background:transparent;
  font-size:13px;font-weight:600;
  color:var(--ink-3);
  cursor:pointer;
  border-radius:var(--r-pill);
  transition:all .2s var(--ease);
}
.view-toggle button.active{
  background:var(--white);
  color:var(--ink);
  box-shadow:0 1px 3px rgba(0,0,0,.08),0 1px 2px rgba(0,0,0,.04);
}
.view-toggle button:not(.active):hover{color:var(--ink-2)}

/* ============================================
   FILTER TABS — colorful pills
   ============================================ */
.filter-tabs{
  display:flex;gap:8px;
  margin-bottom:14px;
  overflow-x:auto;
  -webkit-overflow-scrolling:touch;
  scrollbar-width:none;
  padding-bottom:2px;
}
.filter-tabs::-webkit-scrollbar{display:none}
.filter-tab{
  padding:6px 14px;
  border-radius:var(--r-pill);
  border:1.5px solid var(--border);
  background:var(--white);
  color:var(--ink-2);
  font-weight:500;font-size:13px;
  cursor:pointer;transition:all .15s var(--ease);
  white-space:nowrap;flex-shrink:0;
}
.filter-tab:hover{border-color:var(--cash);color:var(--cash)}
.filter-tab.active{
  border-color:transparent;
  background:var(--cash);
  color:var(--white);
  font-weight:600;
}
.filter-tab .count{
  display:inline-flex;align-items:center;justify-content:center;
  min-width:18px;height:17px;
  background:rgba(0,0,0,.07);
  border-radius:var(--r-pill);
  padding:0 5px;font-size:10px;
  margin-left:4px;font-weight:700;
}
.filter-tab.active .count{background:rgba(255,255,255,.3);color:var(--white)}

/* ============================================
   SEARCH
   ============================================ */
.search-bar-wrap{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}
.search-input{
  width:100%;
  padding:9px 12px 9px 36px;
  border:1.5px solid var(--border);border-radius:var(--r);
  font-size:14px;color:var(--ink);
  background:var(--white) url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='15' height='15' fill='%23B8BFCC' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85zm-5.242.156a5 5 0 1 1 0-10 5 5 0 0 1 0 10z'/%3E%3C/svg%3E") no-repeat 12px center;
  transition:border-color .15s,box-shadow .15s;
}
.search-input:focus{outline:none;border-color:var(--cash);box-shadow:0 0 0 3px rgba(91,95,199,.1)}
.search-input::placeholder{color:var(--ink-4)}
.search-row{display:flex;gap:8px}
.district-select{
  width:100%;padding:9px 28px 9px 12px;
  border:1.5px solid var(--border);border-radius:var(--r);
  font-size:14px;color:var(--ink);background:var(--white);
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%23B8BFCC' viewBox='0 0 16 16'%3E%3Cpath d='M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 10px center;
  cursor:pointer;
}
.district-select:focus{outline:none;border-color:var(--cash)}
.search-clear{
  background:var(--white);border:1.5px solid var(--border);
  color:var(--ink-3);cursor:pointer;font-size:12px;font-weight:500;
  padding:6px 12px;border-radius:var(--r);
  transition:all .15s;white-space:nowrap;
}
.search-clear:hover{border-color:var(--gop);color:var(--gop)}
.search-result-count{font-size:13px;color:var(--ink-3);padding:0 0 8px}
.highlight-match{background:rgba(91,95,199,.12);border-radius:2px;padding:0 1px}

/* ============================================
   FINANCE CARD — white, thin accent stripe
   ============================================ */
.finance-card{
  background:var(--white);
  border-radius:var(--r);
  border:1px solid var(--border);
  overflow:hidden;
  margin-bottom:24px;
}
.finance-card__header{
  padding:16px;
  background:var(--white);
  border-bottom:1px solid var(--border-soft);
}
.finance-card__title{
  font-size:16px;font-weight:700;
  color:var(--ink);margin:0;letter-spacing:-.015em;
}
.finance-card__subtitle{font-size:12px;color:var(--ink-3);margin-top:2px}
.finance-card__footer{
  padding:10px 16px;
  background:var(--tint);
  border-top:1px solid var(--border-soft);
  font-size:11px;color:var(--ink-4);
}

/* ============================================
   MOBILE CARDS
   ============================================ */
.candidate-cards{display:flex;flex-direction:column}

/* Race header — white bg, bold left accent */
.m-race-header{
  padding:10px 16px;
  background:var(--tint);
  border-bottom:1px solid var(--border);
  border-left:4px solid var(--cash);
  font-weight:700;font-size:13px;
  color:var(--ink);
  display:flex;justify-content:space-between;align-items:center;
}
.m-race-header__totals{
  font-family:var(--mono);font-size:12px;font-weight:500;
  color:var(--raised);
  background:var(--raised-soft);
  padding:2px 10px;border-radius:var(--r-pill);
}

/* Party sub-header */
.m-party-header{
  padding:5px 16px;
  background:var(--white);
  border-bottom:1px solid var(--border-soft);
  font-weight:500;font-size:12px;
  color:var(--ink-2);
  display:flex;align-items:center;gap:6px;
}
.m-party-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}

/* Candidate row */
.m-candidate{
  padding:12px 16px;
  border-bottom:1px solid var(--border-soft);
  cursor:pointer;
  transition:background .1s;
  display:flex;align-items:flex-start;gap:10px;
}
.m-candidate:active{background:var(--tint)}

.m-party-bar{
  width:3px;min-height:38px;
  border-radius:var(--r-pill);
  flex-shrink:0;align-self:stretch;
}
.m-party-bar--republican{background:var(--gop)}
.m-party-bar--democrat{background:var(--dem)}
.m-party-bar--independent{background:var(--ind)}
.m-party-bar--libertarian{background:var(--lib)}
.m-party-bar--other{background:var(--oth)}

.m-candidate__body{flex:1;min-width:0}
.m-candidate__top{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:2px}
.m-candidate__name{font-weight:600;font-size:14px;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.m-candidate__badge{
  display:inline-flex;align-items:center;
  padding:2px 8px;font-size:10px;font-weight:700;
  border-radius:var(--r-pill);letter-spacing:.04em;
  flex-shrink:0;
}
.m-candidate__committee{font-size:12px;color:var(--ink-4);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:6px}

/* Money row */
.m-candidate__money{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
.m-money-cell{text-align:center;padding:4px 0;background:var(--tint);border-radius:6px}
.m-money-cell__label{font-size:9px;font-weight:600;letter-spacing:.06em;text-transform:uppercase;color:var(--ink-4);margin-bottom:1px}
.m-money-cell__value{font-family:var(--mono);font-weight:500;font-size:13px}
.m-money-cell__value--raised{color:var(--raised)}
.m-money-cell__value--spent{color:var(--spent)}
.m-money-cell__value--coh{color:var(--cash)}

/* Grand total */
.m-grand-total{
  display:grid;grid-template-columns:repeat(3,1fr);gap:4px;
  padding:12px 16px;
  background:var(--tint);
  border-top:2px solid var(--border);
}
.m-grand-total .m-money-cell{background:var(--white);padding:8px 0;border:1px solid var(--border-soft);border-radius:var(--r)}
.m-grand-total .m-money-cell__label{font-weight:700;color:var(--ink-2);font-size:9px}
.m-grand-total .m-money-cell__value{font-size:14px;font-weight:500}

/* Committee card */
.m-committee{padding:12px 16px;border-bottom:1px solid var(--border-soft);cursor:pointer;transition:background .1s}
.m-committee:active{background:var(--tint)}
.m-committee__name{font-weight:600;font-size:14px;color:var(--ink);margin-bottom:6px;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.m-committee__badge{display:inline-flex;background:var(--ind-bg);color:var(--ind);font-size:10px;padding:2px 8px;border-radius:var(--r-pill);font-weight:600}

/* ============================================
   DESKTOP TABLE
   ============================================ */
.desktop-table-wrap{display:none}

.finance-table{width:100%;border-collapse:collapse}
.finance-table thead{background:var(--tint);border-bottom:1.5px solid var(--border)}
.finance-table th{
  padding:10px 16px;text-align:left;
  font-weight:600;font-size:11px;
  text-transform:uppercase;letter-spacing:.07em;
  color:var(--ink-3);white-space:nowrap;
  cursor:pointer;user-select:none;transition:color .15s;
}
.finance-table th:hover{color:var(--cash)}
.finance-table th.text-right{text-align:right}
.finance-table td{padding:10px 16px;border-bottom:1px solid var(--border-soft);vertical-align:middle}
.finance-table tbody tr{transition:background .1s;cursor:pointer}
.finance-table tbody tr:hover{background:var(--tint)}

/* Race header row — white with left accent */
.race-header{background:var(--tint)!important;border-left:4px solid var(--cash);cursor:default!important}
.race-header:hover{background:var(--tint)!important}
.race-header td{font-weight:700;font-size:13px;padding:10px 16px;border-bottom:1px solid var(--border);color:var(--ink)}

/* Party subheader */
.party-subheader{background:var(--white);cursor:default!important}
.party-subheader:hover{background:var(--white)!important}
.party-subheader td{font-weight:500;font-size:12px;padding:6px 16px;border-bottom:1px solid var(--border-soft);color:var(--ink-2)}

.finance-candidate{display:flex;align-items:center;gap:10px}
.party-bar{width:3px;height:28px;border-radius:var(--r-pill);flex-shrink:0}
.party-bar--republican{background:var(--gop)}
.party-bar--democrat{background:var(--dem)}
.party-bar--independent{background:var(--ind)}
.party-bar--libertarian{background:var(--lib)}
.party-bar--other{background:var(--oth)}

.candidate-name{font-weight:500;font-size:14px;color:var(--ink)}
.candidate-committee{font-size:12px;color:var(--ink-4);margin-top:1px}

.money{font-family:var(--mono);font-weight:500;text-align:right;font-size:13px}
.money--raised{color:var(--raised)}
.money--spent{color:var(--spent)}
.money--coh{color:var(--cash)}

.finance-table tfoot{background:var(--tint);border-top:2px solid var(--border)}
.finance-table tfoot td{padding:14px 16px;font-weight:700;border-bottom:none}

/* ============================================
   DETAIL VIEW
   ============================================ */
.btn-back{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--white);border:1.5px solid var(--border);
  border-radius:var(--r);padding:7px 14px;
  cursor:pointer;font-size:13px;color:var(--ink-2);font-weight:500;
  margin-bottom:16px;transition:all .15s;
}
.btn-back:hover{border-color:var(--cash);color:var(--cash)}

/* Stat strip */
.detail-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:var(--border-soft)}
.detail-stat{text-align:center;padding:16px 12px;background:var(--white)}
.detail-stat__label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.06em;color:var(--ink-4);margin-bottom:4px}
.detail-stat__value{font-family:var(--mono);font-size:18px;font-weight:500}

.report-badge{display:inline-flex;padding:2px 8px;font-size:11px;font-weight:600;border-radius:var(--r-pill);background:var(--cash-soft);color:var(--cash)}

/* Contrib stat cards */
.contrib-stat-cards{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px}
.contrib-stat-card{background:var(--white);border:1.5px solid var(--border);border-radius:var(--r);padding:12px;text-align:center}
.contrib-stat-card__label{font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:.05em;color:var(--ink-4);margin-bottom:2px}
.contrib-stat-card__value{font-size:20px;font-weight:700;font-family:var(--mono)}

.type-badge{
  display:inline-flex;align-items:center;gap:4px;
  background:var(--tint);border:1px solid var(--border-soft);
  border-radius:var(--r-pill);padding:4px 10px;margin:3px;font-size:12px;
}
.type-badge strong{color:var(--ink);font-weight:600}
.type-badge span{color:var(--ink-3)}

/* Year / type sections */
.year-header{
  background:var(--tint);border-left:4px solid var(--cash);
  padding:10px 16px;border-bottom:1px solid var(--border);
  font-weight:700;font-size:13px;
  display:flex;justify-content:space-between;color:var(--ink);
}
.year-header span:last-child{font-family:var(--mono);color:var(--raised);font-weight:500}

.type-toggle{
  background:var(--white);padding:8px 16px;
  border-bottom:1px solid var(--border-soft);
  font-weight:500;font-size:13px;
  display:flex;justify-content:space-between;
  cursor:pointer;user-select:none;color:var(--ink-2);
}
.type-toggle:active{background:var(--tint)}

/* Donor rows */
.donor-row{display:flex;justify-content:space-between;padding:8px 16px;border-bottom:1px solid var(--border-soft);font-size:13px;align-items:center}
.donor-row__name{font-weight:500;color:var(--ink)}
.donor-row__amount{font-family:var(--mono);font-weight:500;color:var(--raised);font-size:13px}

/* Reports */
.reports-list{display:flex;flex-direction:column}
.report-item{padding:10px 16px;border-bottom:1px solid var(--border-soft)}
.report-item__name{font-weight:500;font-size:14px;color:var(--ink);margin-bottom:4px}
.report-item__meta{font-size:12px;color:var(--ink-3);display:flex;flex-wrap:wrap;gap:8px;align-items:center}

/* ============================================
   RESPONSIVE 768px+
   ============================================ */
@media(min-width:768px){
  .container{padding:24px 20px}
  .view-toggle{width:fit-content;min-width:280px}
  .search-bar-wrap{flex-direction:row;align-items:center}
  .search-input{flex:1;min-width:220px;width:auto}
  .district-select{width:auto;min-width:160px}
  .candidate-cards{display:none}
  .desktop-table-wrap{display:block}
  .finance-card__header{padding:16px 24px}
  .finance-card__title{font-size:18px}
  .finance-card__footer{padding:10px 24px}
  .detail-stat__value{font-size:22px}
  .contrib-stat-cards{grid-template-columns:repeat(3,1fr)}
  .page-title{font-size:24px}
}

@media(prefers-reduced-motion:reduce){
  html{scroll-behavior:auto}
  *,*::before,*::after{transition:none!important;animation:none!important}
}
</style>
</head>
<body>
<div class="container">
  <h1 class="page-title">Campaign Finance</h1>
  <p class="page-sub">Georgia 2026 Election Cycle</p>
  <div class="view-toggle" id="view-toggle">
    <button class="active" onclick="setViewMode('candidates')">Candidates</button>
    <button onclick="setViewMode('committees')">Committees</button>
  </div>
  <div class="filter-tabs" id="filters"></div>
  <div class="search-bar-wrap">
    <input type="text" class="search-input" id="search-input" placeholder="Search candidates..." oninput="onSearchInput()" />
    <div class="search-row">
      <select class="district-select" id="district-select" onchange="onDistrictChange()" style="display:none"><option value="">All Districts</option></select>
      <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">Clear</button>
    </div>
  </div>
  <div id="search-result-count" class="search-result-count" style="display:none"></div>
  <div id="main-view"></div>
  <div id="detail-view" style="display:none"></div>
</div>

<script>
const SUPABASE_URL="https://kxvmvffmkvctrqmbqpbk.supabase.co";
const SUPABASE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4dm12ZmZta3ZjdHJxbWJxcGJrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MTk3MjcsImV4cCI6MjA4NTE5NTcyN30.LzFJgCOBtKIFlBHg7uc5-g7LekKf7wrvFflgZnE5QBM";

async function supaFetch(t,q){var r=await fetch(SUPABASE_URL+"/rest/v1/"+t+"?"+q,{headers:{apikey:SUPABASE_KEY,Authorization:"Bearer "+SUPABASE_KEY}});if(!r.ok)throw new Error("Supabase "+r.status+": "+r.statusText);return r.json()}
var fmt=function(v){return(v==null||isNaN(v))?"$0":"$"+Math.round(Number(v)).toLocaleString()};

function getCategory(office){if(!office)return"Other";var o=office.toLowerCase();if(["governor","lt gov","lieutenant","secretary of state","attorney general","commissioner","superintendent","insurance","labor","agriculture","comptroller"].some(function(k){return o.includes(k)}))return"Statewide";if(o.includes("senator")||o.includes("senate"))return"State Senate";if(o.includes("representative")||o.includes("house"))return"State House";return"Other"}

function partyClass(p){if(!p)return"other";var l=p.trim().toLowerCase();if(l==="r"||l==="rep"||l.includes("republican"))return"republican";if(l==="d"||l==="dem"||l.includes("democrat"))return"democrat";if(l==="i"||l==="ind"||l==="np"||l.includes("independent")||l.includes("nonpartisan")||l.includes("non-partisan"))return"independent";if(l==="l"||l==="lib"||l.includes("libertarian"))return"libertarian";return"other"}

var PARTY_STYLES={
  republican:{bg:"var(--gop-bg)",color:"var(--gop)",dot:"var(--gop)"},
  democrat:{bg:"var(--dem-bg)",color:"var(--dem)",dot:"var(--dem)"},
  independent:{bg:"var(--ind-bg)",color:"var(--ind)",dot:"var(--ind)"},
  libertarian:{bg:"var(--lib-bg)",color:"var(--lib)",dot:"var(--lib)"},
  other:{bg:"var(--oth-bg)",color:"var(--oth)",dot:"var(--oth)"}
};
var PARTY_DISPLAY={republican:"Republican",democrat:"Democrat",libertarian:"Libertarian",independent:"Independent / NP",other:"Other"};
var PARTY_ORDER=["republican","democrat","libertarian","independent","other"];

function partyLabel(p){if(!p)return"-";var l=p.trim().toLowerCase();if(l==="r"||l==="rep"||l.includes("republican"))return"GOP";if(l==="d"||l==="dem"||l.includes("democrat"))return"DEM";if(l==="i"||l==="ind"||l.includes("independent"))return"IND";if(l==="np"||l.includes("nonpartisan")||l.includes("non-partisan"))return"NP";if(l==="l"||l==="lib"||l.includes("libertarian"))return"LIB";return p.substring(0,3).toUpperCase()}

function badgeHTML(pv,es){var pc=partyClass(pv),s=PARTY_STYLES[pc]||PARTY_STYLES.other;return'<span class="m-candidate__badge" style="background:'+s.bg+';color:'+s.color+';'+(es||'')+'">'+partyLabel(pv)+'</span>'}
function displayName(r){if(r.candidate_first_name&&r.candidate_last_name)return r.candidate_first_name+" "+r.candidate_last_name;return r.candidate_committee_name||r.candidate_last_name||"Unknown"}
function raceLabel(r){if(!r.office_sought)return"Other";return r.district?r.office_sought+" \u2014 Dist. "+r.district:r.office_sought}

var allCandidates=[],allCommittees=[];
var activeFilter="Statewide",sortKey="total_contributions",sortDir="desc";
var categoryCounts={},committeeCategoryCounts={};
var viewMode="candidates",searchQuery="",selectedDistrict="";
var _st;

function onSearchInput(){clearTimeout(_st);_st=setTimeout(function(){searchQuery=document.getElementById("search-input").value.trim().toLowerCase();document.getElementById("search-clear").style.display=(searchQuery||selectedDistrict)?"inline-block":"none";renderTable()},200)}
function onDistrictChange(){selectedDistrict=document.getElementById("district-select").value;document.getElementById("search-clear").style.display=(searchQuery||selectedDistrict)?"inline-block":"none";renderTable()}
function clearSearch(){searchQuery="";selectedDistrict="";document.getElementById("search-input").value="";document.getElementById("district-select").value="";document.getElementById("search-clear").style.display="none";document.getElementById("search-result-count").style.display="none";renderTable()}

function updateDistrictDropdown(){var ds=document.getElementById("district-select");if(viewMode==="candidates"&&(activeFilter==="State Senate"||activeFilter==="State House")){var dd=new Set();allCandidates.forEach(function(c){if(getCategory(c.office_sought)===activeFilter&&c.district)dd.add(String(c.district))});var so=Array.from(dd).sort(function(a,b){return(parseInt(a)||999)-(parseInt(b)||999)});ds.innerHTML='<option value="">All Districts</option>'+so.map(function(d){return'<option value="'+d+'"'+(selectedDistrict===d?' selected':'')+'>District '+d+'</option>'}).join("");ds.style.display="inline-block"}else{ds.style.display="none";selectedDistrict="";ds.value=""}}

function highlightText(t){if(!searchQuery||!t)return t||"";var i=t.toLowerCase().indexOf(searchQuery);if(i===-1)return t;return t.substring(0,i)+'<span class="highlight-match">'+t.substring(i,i+searchQuery.length)+'</span>'+t.substring(i+searchQuery.length)}

async function loadData(){
  document.getElementById("main-view").innerHTML='<div class="loading"><div class="spinner"></div>Loading data\u2026</div>';
  try{
    allCandidates=await supaFetch("campaign_ga_toplines_v","select=filing_entity_id,candidate_first_name,candidate_last_name,candidate_committee_name,office_sought,district,total_contributions,total_expenditures,cash_on_hand,party_affiliation,election_cycle&election_cycle=eq.2026%20Georgia%20State%20Election&order=total_contributions.desc.nullslast&limit=10000");
    categoryCounts={Statewide:0,"State Senate":0,"State House":0,Other:0};
    allCandidates.forEach(function(c){var cat=getCategory(c.office_sought);if(categoryCounts[cat]!==undefined)categoryCounts[cat]++;else categoryCounts["Other"]++});

    allCommittees=await supaFetch("campaign_ga_candidates","select=filing_entity_id,candidate_committee_name,committee_type,contributions,expenditures,ending_cash_balance,party_affiliation,election_cycle,leadership_role,committee_treasurer_first_name,committee_treasurer_last_name,committee_chair_first_name,committee_chair_last_name&filer_type=eq.RO&order=contributions.desc.nullslast&limit=10000");
    committeeCategoryCounts={};
    allCommittees.forEach(function(c){var cat=c.committee_type||"Other";if(!committeeCategoryCounts[cat])committeeCategoryCounts[cat]=0;committeeCategoryCounts[cat]++});

    renderViewToggle();renderFilters();updateDistrictDropdown();renderTable();
  }catch(err){document.getElementById("main-view").innerHTML='<div class="error-box"><strong>Failed to load data</strong>'+err.message+'</div>'}
}

function setViewMode(m){viewMode=m;searchQuery="";selectedDistrict="";document.getElementById("search-input").value="";document.getElementById("search-input").placeholder=m==="candidates"?"Search candidates...":"Search committees...";document.getElementById("search-clear").style.display="none";document.getElementById("search-result-count").style.display="none";activeFilter=m==="candidates"?"Statewide":(Object.keys(committeeCategoryCounts).sort()[0]||"Political Action Committee");renderViewToggle();renderFilters();updateDistrictDropdown();renderTable()}

function renderViewToggle(){document.getElementById("view-toggle").innerHTML='<button class="'+(viewMode==="candidates"?"active":"")+'" onclick="setViewMode(\'candidates\')">Candidates ('+allCandidates.length+')</button><button class="'+(viewMode==="committees"?"active":"")+'" onclick="setViewMode(\'committees\')">Committees ('+allCommittees.length+')</button>'}

function renderFilters(){var el=document.getElementById("filters");var f=viewMode==="candidates"?["Statewide","State Senate","State House","Other"]:Object.keys(committeeCategoryCounts).sort(function(a,b){return(committeeCategoryCounts[b]||0)-(committeeCategoryCounts[a]||0)});var c=viewMode==="candidates"?categoryCounts:committeeCategoryCounts;el.innerHTML=f.map(function(x){return'<button class="filter-tab'+(x===activeFilter?' active':'')+'" onclick="setFilter(\''+x+'\')">'+x+'<span class="count">'+(c[x]||0)+'</span></button>'}).join("")}

function setFilter(f){activeFilter=f;selectedDistrict="";document.getElementById("district-select").value="";renderFilters();updateDistrictDropdown();renderTable()}
function setSort(k){if(sortKey===k)sortDir=sortDir==="asc"?"desc":"asc";else{sortKey=k;sortDir="desc"}renderTable()}
function sortArrow(k){if(sortKey!==k)return" \u21C5";return sortDir==="asc"?" \u2191":" \u2193"}

function renderTable(){
  document.getElementById("detail-view").style.display="none";
  document.getElementById("main-view").style.display="block";
  if(viewMode==="committees"){renderCommitteeTable();return}

  var filtered=allCandidates.filter(function(c){if(getCategory(c.office_sought)!==activeFilter)return false;if(selectedDistrict&&String(c.district)!==selectedDistrict)return false;if(searchQuery){var n=displayName(c).toLowerCase(),cm=(c.candidate_committee_name||"").toLowerCase();if(n.indexOf(searchQuery)===-1&&cm.indexOf(searchQuery)===-1)return false}return true});

  filtered.sort(function(a,b){var va=a[sortKey],vb=b[sortKey];if(va==null)va=sortDir==="asc"?Infinity:-Infinity;if(vb==null)vb=sortDir==="asc"?Infinity:-Infinity;if(typeof va==="string"){va=va.toLowerCase();vb=(vb||"").toLowerCase()}else{va=Number(va);vb=Number(vb)}return sortDir==="asc"?(va<vb?-1:va>vb?1:0):(va>vb?-1:va<vb?1:0)});

  var grouped=new Map();
  filtered.forEach(function(c){var k=raceLabel(c);if(!grouped.has(k))grouped.set(k,[]);grouped.get(k).push(c)});
  var sR=Array.from(grouped.keys());
  if(activeFilter==="State House"||activeFilter==="State Senate")sR.sort(function(a,b){return(parseInt((a.match(/Dist\.\s*(\d+)/i)||[])[1])||999)-(parseInt((b.match(/Dist\.\s*(\d+)/i)||[])[1])||999)});

  var tot=filtered.reduce(function(a,c){return{raised:a.raised+(Number(c.total_contributions)||0),spent:a.spent+(Number(c.total_expenditures)||0),coh:a.coh+(Number(c.cash_on_hand)||0)}},{raised:0,spent:0,coh:0});

  var mob='';
  sR.forEach(function(race){
    var cs=grouped.get(race);
    var sub=cs.reduce(function(a,c){return{r:a.r+(Number(c.total_contributions)||0)}},{r:0});
    mob+='<div class="m-race-header"><span>'+race+'</span><span class="m-race-header__totals">'+fmt(sub.r)+'</span></div>';
    var bp=new Map();cs.forEach(function(c){var pc=partyClass(c.party_affiliation);if(!bp.has(pc))bp.set(pc,[]);bp.get(pc).push(c)});
    var sp=PARTY_ORDER.filter(function(p){return bp.has(p)});bp.forEach(function(_,p){if(sp.indexOf(p)===-1)sp.push(p)});
    sp.forEach(function(pc){
      var pcs=bp.get(pc);pcs.sort(function(a,b){return(Number(b.total_contributions)||0)-(Number(a.total_contributions)||0)});
      var ps=PARTY_STYLES[pc]||PARTY_STYLES.other;
      mob+='<div class="m-party-header"><span class="m-party-dot" style="background:'+ps.dot+'"></span>'+(PARTY_DISPLAY[pc]||pc)+' ('+pcs.length+')</div>';
      pcs.forEach(function(c){
        var name=displayName(c),hN=searchQuery?highlightText(name):name;
        var comm=(c.candidate_committee_name&&c.candidate_first_name)?'<div class="m-candidate__committee">'+(searchQuery?highlightText(c.candidate_committee_name):c.candidate_committee_name)+'</div>':'';
        mob+='<div class="m-candidate" onclick="showDetail('+c.filing_entity_id+')"><div class="m-party-bar m-party-bar--'+pc+'"></div><div class="m-candidate__body"><div class="m-candidate__top"><span class="m-candidate__name">'+hN+'</span>'+badgeHTML(c.party_affiliation)+'</div>'+comm+'<div class="m-candidate__money"><div class="m-money-cell"><div class="m-money-cell__label">Raised</div><div class="m-money-cell__value m-money-cell__value--raised">'+fmt(c.total_contributions)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Spent</div><div class="m-money-cell__value m-money-cell__value--spent">'+fmt(c.total_expenditures)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Cash</div><div class="m-money-cell__value m-money-cell__value--coh">'+fmt(c.cash_on_hand)+'</div></div></div></div></div>'
      })
    })
  });
  if(filtered.length===0)mob='<div style="text-align:center;padding:48px 16px;color:var(--ink-4);font-size:14px">'+(searchQuery||selectedDistrict?'No results.':'No candidates.')+'</div>';

  var desk='';
  sR.forEach(function(race){
    var cs=grouped.get(race);
    var sub=cs.reduce(function(a,c){return{r:a.r+(Number(c.total_contributions)||0),s:a.s+(Number(c.total_expenditures)||0),h:a.h+(Number(c.cash_on_hand)||0)}},{r:0,s:0,h:0});
    desk+='<tr class="race-header"><td colspan="3">'+race+'</td><td class="money money--raised" style="font-size:12px">'+fmt(sub.r)+'</td><td class="money money--spent" style="font-size:12px">'+fmt(sub.s)+'</td><td class="money money--coh" style="font-size:12px">'+fmt(sub.h)+'</td></tr>';
    var bp=new Map();cs.forEach(function(c){var pc=partyClass(c.party_affiliation);if(!bp.has(pc))bp.set(pc,[]);bp.get(pc).push(c)});
    var sp=PARTY_ORDER.filter(function(p){return bp.has(p)});bp.forEach(function(_,p){if(sp.indexOf(p)===-1)sp.push(p)});
    sp.forEach(function(pc){
      var pcs=bp.get(pc);var ps=PARTY_STYLES[pc]||PARTY_STYLES.other;
      pcs.sort(function(a,b){var va=a[sortKey],vb=b[sortKey];if(va==null)return 1;if(vb==null)return-1;var cm=typeof va==="string"?va.localeCompare(vb):(Number(va)||0)-(Number(vb)||0);return sortDir==="asc"?cm:-cm});
      var pS=pcs.reduce(function(a,c){return{r:a.r+(Number(c.total_contributions)||0),s:a.s+(Number(c.total_expenditures)||0),h:a.h+(Number(c.cash_on_hand)||0)}},{r:0,s:0,h:0});
      desk+='<tr class="party-subheader"><td colspan="3"><span style="display:inline-block;width:8px;height:8px;border-radius:50%;background:'+ps.dot+';margin-right:8px;vertical-align:middle"></span>'+(PARTY_DISPLAY[pc]||pc)+' ('+pcs.length+')</td><td class="money money--raised" style="font-size:12px">'+fmt(pS.r)+'</td><td class="money money--spent" style="font-size:12px">'+fmt(pS.s)+'</td><td class="money money--coh" style="font-size:12px">'+fmt(pS.h)+'</td></tr>';
      pcs.forEach(function(c){
        var name=displayName(c),hN=searchQuery?highlightText(name):name;
        var comm=(c.candidate_committee_name&&c.candidate_first_name)?'<div class="candidate-committee">'+(searchQuery?highlightText(c.candidate_committee_name):c.candidate_committee_name)+'</div>':'';
        desk+='<tr onclick="showDetail('+c.filing_entity_id+')"><td><div class="finance-candidate"><div class="party-bar party-bar--'+pc+'"></div><div><span class="candidate-name">'+hN+'</span>'+comm+'</div></div></td><td>'+badgeHTML(c.party_affiliation)+'</td><td style="font-size:13px;color:var(--ink-3)">'+(c.office_sought||'')+(c.district?' '+c.district:'')+'</td><td class="money money--raised">'+fmt(c.total_contributions)+'</td><td class="money money--spent">'+fmt(c.total_expenditures)+'</td><td class="money money--coh">'+fmt(c.cash_on_hand)+'</td></tr>'
      })
    })
  });
  if(filtered.length===0)desk='<tr><td colspan="6" style="text-align:center;padding:48px;color:var(--ink-4)">No results.</td></tr>';

  var ce=document.getElementById("search-result-count");
  if(searchQuery||selectedDistrict){ce.style.display="block";var pp=[];if(searchQuery)pp.push('"'+searchQuery+'"');if(selectedDistrict)pp.push('District '+selectedDistrict);ce.textContent=filtered.length+" result"+(filtered.length!==1?"s":"")+" for "+pp.join(", ")}else{ce.style.display="none"}

  document.getElementById("main-view").innerHTML=
    '<div class="finance-card"><div class="finance-card__header"><div class="finance-card__title">'+activeFilter+'</div><div class="finance-card__subtitle">'+filtered.length+' filer'+(filtered.length!==1?'s':'')+' \u00B7 Tap any row for details</div></div>'+
    '<div class="candidate-cards">'+mob+(filtered.length>0?'<div class="m-grand-total"><div class="m-money-cell"><div class="m-money-cell__label">Total Raised</div><div class="m-money-cell__value m-money-cell__value--raised">'+fmt(tot.raised)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Total Spent</div><div class="m-money-cell__value m-money-cell__value--spent">'+fmt(tot.spent)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Cash on Hand</div><div class="m-money-cell__value m-money-cell__value--coh">'+fmt(tot.coh)+'</div></div></div>':'')+'</div>'+
    '<div class="desktop-table-wrap"><table class="finance-table"><thead><tr><th onclick="setSort(\'candidate_last_name\')">Candidate'+sortArrow('candidate_last_name')+'</th><th onclick="setSort(\'party_affiliation\')">Party'+sortArrow('party_affiliation')+'</th><th onclick="setSort(\'office_sought\')">Office'+sortArrow('office_sought')+'</th><th class="text-right" onclick="setSort(\'total_contributions\')">Raised'+sortArrow('total_contributions')+'</th><th class="text-right" onclick="setSort(\'total_expenditures\')">Spent'+sortArrow('total_expenditures')+'</th><th class="text-right" onclick="setSort(\'cash_on_hand\')">Cash'+sortArrow('cash_on_hand')+'</th></tr></thead><tbody>'+desk+'</tbody><tfoot><tr><td colspan="3" style="text-align:right;padding-right:16px;color:var(--ink-2)">Grand Total</td><td class="money money--raised">'+fmt(tot.raised)+'</td><td class="money money--spent">'+fmt(tot.spent)+'</td><td class="money money--coh">'+fmt(tot.coh)+'</td></tr></tfoot></table></div>'+
    '<div class="finance-card__footer">Data from Georgia Ethics Commission \u00B7 Updated daily</div></div>'
}

function renderCommitteeTable(){
  var filtered=allCommittees.filter(function(c){if((c.committee_type||"Other")!==activeFilter)return false;if(searchQuery&&(c.candidate_committee_name||"").toLowerCase().indexOf(searchQuery)===-1)return false;return true});
  var csk=sortKey==="total_contributions"?"contributions":sortKey==="total_expenditures"?"expenditures":sortKey==="cash_on_hand"?"ending_cash_balance":sortKey==="candidate_last_name"?"candidate_committee_name":sortKey;
  filtered.sort(function(a,b){var va=a[csk],vb=b[csk];if(va==null)va=sortDir==="asc"?Infinity:-Infinity;if(vb==null)vb=sortDir==="asc"?Infinity:-Infinity;if(typeof va==="string"){va=va.toLowerCase();vb=(vb||"").toLowerCase()}else{va=Number(va);vb=Number(vb)}return sortDir==="asc"?(va<vb?-1:1):(va>vb?-1:1)});
  var tot=filtered.reduce(function(a,c){return{raised:a.raised+(Number(c.contributions)||0),spent:a.spent+(Number(c.expenditures)||0),coh:a.coh+(Number(c.ending_cash_balance)||0)}},{raised:0,spent:0,coh:0});

  var mob='';
  filtered.forEach(function(c){var name=c.candidate_committee_name||"Unknown",hN=searchQuery?highlightText(name):name;var lb=c.leadership_role?'<span class="m-committee__badge">'+c.leadership_role+'</span>':'';
    mob+='<div class="m-committee" onclick="showCommitteeDetail('+c.filing_entity_id+')"><div class="m-committee__name">'+hN+lb+'</div><div class="m-candidate__money"><div class="m-money-cell"><div class="m-money-cell__label">Raised</div><div class="m-money-cell__value m-money-cell__value--raised">'+fmt(c.contributions)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Spent</div><div class="m-money-cell__value m-money-cell__value--spent">'+fmt(c.expenditures)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Cash</div><div class="m-money-cell__value m-money-cell__value--coh">'+fmt(c.ending_cash_balance)+'</div></div></div></div>'});
  if(filtered.length===0)mob='<div style="text-align:center;padding:48px;color:var(--ink-4)">No committees.</div>';

  var desk='';
  filtered.forEach(function(c){var name=c.candidate_committee_name||"Unknown",hN=searchQuery?highlightText(name):name;var lb=c.leadership_role?'<span class="m-committee__badge" style="margin-left:8px">'+c.leadership_role+'</span>':'';
    desk+='<tr onclick="showCommitteeDetail('+c.filing_entity_id+')"><td><span class="candidate-name">'+hN+'</span>'+lb+'</td><td class="money money--raised">'+fmt(c.contributions)+'</td><td class="money money--spent">'+fmt(c.expenditures)+'</td><td class="money money--coh">'+fmt(c.ending_cash_balance)+'</td></tr>'});
  if(filtered.length===0)desk='<tr><td colspan="4" style="text-align:center;padding:48px;color:var(--ink-4)">No committees.</td></tr>';

  var ce=document.getElementById("search-result-count");if(searchQuery){ce.style.display="block";ce.textContent=filtered.length+' result'+(filtered.length!==1?'s':'')+' for "'+searchQuery+'"'}else{ce.style.display="none"}

  document.getElementById("main-view").innerHTML=
    '<div class="finance-card"><div class="finance-card__header"><div class="finance-card__title">'+activeFilter+'</div><div class="finance-card__subtitle">'+filtered.length+' committee'+(filtered.length!==1?'s':'')+' \u00B7 Tap any row for details</div></div>'+
    '<div class="candidate-cards">'+mob+(filtered.length>0?'<div class="m-grand-total"><div class="m-money-cell"><div class="m-money-cell__label">Total Raised</div><div class="m-money-cell__value m-money-cell__value--raised">'+fmt(tot.raised)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Total Spent</div><div class="m-money-cell__value m-money-cell__value--spent">'+fmt(tot.spent)+'</div></div><div class="m-money-cell"><div class="m-money-cell__label">Cash on Hand</div><div class="m-money-cell__value m-money-cell__value--coh">'+fmt(tot.coh)+'</div></div></div>':'')+'</div>'+
    '<div class="desktop-table-wrap"><table class="finance-table"><thead><tr><th onclick="setSort(\'candidate_last_name\')">Committee'+sortArrow('candidate_last_name')+'</th><th class="text-right" onclick="setSort(\'total_contributions\')">Raised'+sortArrow('total_contributions')+'</th><th class="text-right" onclick="setSort(\'total_expenditures\')">Spent'+sortArrow('total_expenditures')+'</th><th class="text-right" onclick="setSort(\'cash_on_hand\')">Cash'+sortArrow('cash_on_hand')+'</th></tr></thead><tbody>'+desk+'</tbody><tfoot><tr><td style="text-align:right;padding-right:16px;color:var(--ink-2)">Grand Total</td><td class="money money--raised">'+fmt(tot.raised)+'</td><td class="money money--spent">'+fmt(tot.spent)+'</td><td class="money money--coh">'+fmt(tot.coh)+'</td></tr></tfoot></table></div>'+
    '<div class="finance-card__footer">Data from Georgia Ethics Commission \u00B7 Updated daily</div></div>'
}

function showCommitteeDetail(id){
  id=String(id);var c=allCommittees.find(function(x){return String(x.filing_entity_id)===id});if(!c)return;
  document.getElementById("main-view").style.display="none";var dv=document.getElementById("detail-view");dv.style.display="block";
  dv.innerHTML='<button class="btn-back" onclick="renderTable()">\u2190 Back</button>'+
    '<div class="finance-card"><div class="finance-card__header"><div class="finance-card__title">'+(c.candidate_committee_name||"Unknown")+'</div><div class="finance-card__subtitle">'+(c.committee_type||"Committee")+(c.leadership_role?' \u00B7 '+c.leadership_role:'')+'</div></div>'+
    '<div class="detail-stats"><div class="detail-stat"><div class="detail-stat__label">Raised</div><div class="detail-stat__value" style="color:var(--raised)">'+fmt(c.contributions)+'</div></div><div class="detail-stat"><div class="detail-stat__label">Spent</div><div class="detail-stat__value" style="color:var(--spent)">'+fmt(c.expenditures)+'</div></div><div class="detail-stat"><div class="detail-stat__label">Cash</div><div class="detail-stat__value" style="color:var(--cash)">'+fmt(c.ending_cash_balance)+'</div></div></div>'+
    '<div style="padding:16px"><div style="font-size:12px;font-weight:600;color:var(--ink-3);text-transform:uppercase;letter-spacing:.06em;margin-bottom:12px">Officers</div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px">'+
    (c.committee_treasurer_first_name||c.committee_treasurer_last_name?'<div style="border:1.5px solid var(--border);border-radius:var(--r);padding:12px"><div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px">Treasurer</div><div style="font-weight:600;font-size:14px">'+(c.committee_treasurer_first_name||'')+' '+(c.committee_treasurer_last_name||'')+'</div></div>':'')+
    (c.committee_chair_first_name||c.committee_chair_last_name?'<div style="border:1.5px solid var(--border);border-radius:var(--r);padding:12px"><div style="font-size:10px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:2px">Chair</div><div style="font-weight:600;font-size:14px">'+(c.committee_chair_first_name||'')+' '+(c.committee_chair_last_name||'')+'</div></div>':'')+
    '</div></div><div class="finance-card__footer">Entity ID: '+c.filing_entity_id+' \u00B7 '+(c.election_cycle||'')+'</div></div>';
  window.scrollTo({top:0,behavior:'smooth'})
}

async function showDetail(id){
  id=String(id);var c=allCandidates.find(function(x){return String(x.filing_entity_id)===id});if(!c)return;
  var name=displayName(c);
  document.getElementById("main-view").style.display="none";var dv=document.getElementById("detail-view");dv.style.display="block";
  dv.innerHTML='<button class="btn-back" onclick="renderTable()">\u2190 Back</button>'+
    '<div class="finance-card" id="detail-card"><div class="finance-card__header"><div class="finance-card__title">'+name+'</div><div class="finance-card__subtitle">'+(c.office_sought||'')+(c.district?' \u2014 Dist. '+c.district:'')+' \u00B7 '+badgeHTML(c.party_affiliation,'font-size:9px')+(c.candidate_committee_name?' \u00B7 '+c.candidate_committee_name:'')+'</div></div>'+
    '<div class="detail-stats"><div class="detail-stat"><div class="detail-stat__label">Raised</div><div class="detail-stat__value" style="color:var(--raised)">'+fmt(c.total_contributions)+'</div></div><div class="detail-stat"><div class="detail-stat__label">Spent</div><div class="detail-stat__value" style="color:var(--spent)">'+fmt(c.total_expenditures)+'</div></div><div class="detail-stat"><div class="detail-stat__label">Cash</div><div class="detail-stat__value" style="color:var(--cash)">'+fmt(c.cash_on_hand)+'</div></div></div>'+
    '<div id="contributions-container" style="padding:16px"><div class="loading"><div class="spinner"></div>Loading donors\u2026</div></div>'+
    '<div id="reports-container" style="padding:16px"><div class="loading"><div class="spinner"></div>Loading reports\u2026</div></div>'+
    '<div class="finance-card__footer" id="detail-footer">Entity ID: '+id+'</div></div>';
  window.scrollTo({top:0,behavior:'smooth'});

  try{
    var contribs=await supaFetch("campaign_ga_contributions","select=contributor_first_name,contributor_last_name,contributor_type,transaction_amount,election_year&filing_entity_id=eq."+id+"&order=transaction_amount.desc.nullslast&limit=10000");
    var html="";
    if(contribs.length===0){html='<p style="text-align:center;padding:32px;color:var(--ink-4);font-size:14px">No contribution data found.</p>'}
    else{
      var dm={};contribs.forEach(function(d){var n=((d.contributor_first_name||"")+" "+(d.contributor_last_name||"")).trim()||"Unknown";var y=d.election_year||"Unknown";var t=d.contributor_type||"Unknown";var k=y+"|||"+t+"|||"+n;if(!dm[k])dm[k]={name:n,year:y,type:t,total:0};dm[k].total+=Number(d.transaction_amount)||0});
      var donors=Object.values(dm);donors.sort(function(a,b){return b.total-a.total});
      var tD=contribs.length,tA=contribs.reduce(function(s,d){return s+(Number(d.transaction_amount)||0)},0),avg=tD>0?tA/tD:0;
      var tc={};contribs.forEach(function(d){var t=d.contributor_type||"Unknown";if(!tc[t])tc[t]=0;tc[t]++});
      var tcH="";Object.keys(tc).sort().forEach(function(t){tcH+='<span class="type-badge"><strong>'+t+'</strong> <span>'+tc[t].toLocaleString()+'</span></span>'});

      html='<div style="font-size:15px;font-weight:700;color:var(--ink);margin-bottom:12px">Contributions</div>'+
        '<div class="contrib-stat-cards"><div class="contrib-stat-card"><div class="contrib-stat-card__label">Donations</div><div class="contrib-stat-card__value" style="color:var(--ink)">'+tD.toLocaleString()+'</div></div><div class="contrib-stat-card"><div class="contrib-stat-card__label">Average</div><div class="contrib-stat-card__value" style="color:var(--raised)">'+fmt(avg)+'</div></div></div>'+
        '<div style="margin-bottom:16px"><div style="font-size:11px;font-weight:600;color:var(--ink-4);text-transform:uppercase;letter-spacing:.05em;margin-bottom:6px">By Type</div>'+tcH+'</div>';

      var byY=new Map();donors.forEach(function(d){if(!byY.has(d.year))byY.set(d.year,new Map());var ym=byY.get(d.year);if(!ym.has(d.type))ym.set(d.type,[]);ym.get(d.type).push(d)});
      var sY=Array.from(byY.keys()).sort(function(a,b){return String(b).localeCompare(String(a))});var sid=0;
      sY.forEach(function(year){
        var ym=byY.get(year);var yt=0;ym.forEach(function(ds){ds.forEach(function(d){yt+=d.total})});
        html+='<div style="margin-bottom:16px"><div class="year-header"><span>'+year+'</span><span>'+fmt(yt)+'</span></div>';
        Array.from(ym.keys()).sort().forEach(function(type){
          var td2=ym.get(type);var tt=td2.reduce(function(s,d){return s+d.total},0);var si="cs-"+sid++;
          html+='<div class="type-toggle" onclick="var el=document.getElementById(\''+si+'\');var a=document.getElementById(\''+si+'-a\');if(el.style.display===\'none\'){el.style.display=\'block\';a.textContent=\'\u25BE\'}else{el.style.display=\'none\';a.textContent=\'\u25B8\'}"><span><span id="'+si+'-a" style="display:inline-block;width:16px;color:var(--ink-4)">\u25B8</span>'+type+' <span style="font-weight:400;color:var(--ink-4)">('+td2.length+')</span></span><span style="font-family:var(--mono);font-weight:500;color:var(--raised)">'+fmt(tt)+'</span></div>';
          html+='<div id="'+si+'" style="display:none">';
          td2.forEach(function(d){html+='<div class="donor-row"><span class="donor-row__name">'+d.name+'</span><span class="donor-row__amount">'+fmt(d.total)+'</span></div>'});
          html+='</div>'
        });
        html+='</div>'
      })
    }
    document.getElementById("contributions-container").innerHTML=html
  }catch(err){document.getElementById("contributions-container").innerHTML='<div class="error-box"><strong>Failed to load contributions</strong> '+err.message+'</div>'}

  try{
    var reps=await supaFetch("campaign_ga_filed_reports","select=report_name,report_type,filed_date,due_date,filing_cycle&filing_entity_id=eq."+id+"&order=filed_date.desc.nullslast");
    var rH='<div style="font-size:15px;font-weight:700;color:var(--ink);margin-bottom:12px">Filed Reports</div>';
    if(reps.length===0){rH+='<p style="text-align:center;padding:24px;color:var(--ink-4);font-size:14px">No filed reports.</p>'}
    else{rH+='<div class="reports-list">';reps.forEach(function(r){rH+='<div class="report-item"><div class="report-item__name">'+(r.report_name||'-')+'</div><div class="report-item__meta"><span class="report-badge">'+(r.report_type||'-')+'</span><span>Filed: '+(r.filed_date||'-')+'</span><span>Due: '+(r.due_date||'-')+'</span></div></div>'});rH+='</div>'}
    document.getElementById("reports-container").innerHTML=rH;
    document.getElementById("detail-footer").textContent="Entity ID: "+id+" \u00B7 "+reps.length+" report(s) \u00B7 GA Ethics Commission"
  }catch(err){document.getElementById("reports-container").innerHTML='<div class="error-box"><strong>Failed to load reports</strong> '+err.message+'</div>'}
}

loadData();
</script>
</body>
</html>
